<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tu Empresa — Importación y Exportación de Coches</title>
  <meta name="description" content="Importamos y exportamos coches a medida. Inspección, logística, matriculación y garantía. Pide presupuesto sin compromiso." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {margin:0;font-family:Inter,Arial,sans-serif;background:#fafafa;color:#111;}
    header {background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10;}
    nav {max-width:1100px;margin:0 auto;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;}
    nav a {margin:0 10px;text-decoration:none;color:#111;font-weight:600;}
    .btn {display:inline-block;padding:12px 18px;border-radius:999px;text-decoration:none;font-weight:700;}
    .btn.primary {background:#111;color:#fff;}
    section {max-width:1100px;margin:0 auto;padding:60px 20px;}
    .hero {display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center;}
    @media (max-width:800px){.hero{grid-template-columns:1fr;}}
    .hero img {width:100%;border-radius:10px;}
    .grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;}
    .card {background:#fff;border:1px solid #eee;border-radius:12px;padding:20px;}
    footer {background:#fff;border-top:1px solid #eee;text-align:center;padding:20px;}
  </style>
</head>
<body>
  <header>
    <nav>
      <div><strong>Tu Empresa</strong></div>
      <div>
        <a href="#servicios">Servicios</a>
        <a href="#stock">Stock</a>
        <a href="#contacto" class="btn primary">Contacto</a>
      </div>
    </nav>
  </header>

  <section class="hero">
    <div>
      <h1>Importación y Exportación de Coches</h1>
      <p>Traemos el coche que buscas desde cualquier parte de Europa o EE.UU. y nos encargamos de toda la gestión: transporte, aduanas, matriculación y garantía.</p>
      <a href="#contacto" class="btn primary">Solicitar información</a>
    </div>
    <div>
      <img src="https://picsum.photos/seed/coche1/800/450" alt="Coche ejemplo">
    </div>
  </section>

  <section id="servicios">
    <h2>Servicios</h2>
    <div class="grid">
      <div class="card"><b>Búsqueda a medida</b><p>Encontramos el coche que quieres con historial verificado.</p></div>
      <div class="card"><b>Transporte y aduanas</b><p>Gestión logística completa hasta tu puerta.</p></div>
      <div class="card"><b>Matriculación</b><p>Nos encargamos de ITV y papeles en España.</p></div>
    </div>
  </section>

  <section id="stock">
    <h2>Ejemplos de stock</h2>
    <div class="grid">
      <div class="card">
        <img src="https://picsum.photos/seed/audi/600/350" alt="Audi">
        <p><b>Audi A4 2019</b><br>120.000 km · Diesel</p>
      </div>
      <div class="card">
        <img src="https://picsum.photos/seed/bmw/600/350" alt="BMW">
        <p><b>BMW 330e 2020</b><br>80.000 km · Híbrido</p>
      </div>
      <div class="card">
        <img src="https://picsum.photos/seed/mercedes/600/350" alt="Mercedes">
        <p><b>Mercedes C220d 2018</b><br>150.000 km · Diesel</p>
      </div>
    </div>
  </section>

  <section id="contacto">
    <h2>Contacto</h2>
	
    <form id="contact-form">
    <input type="text" name="nombre" placeholder="Nombre" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="tel" name="telefono" placeholder="Teléfono (opcional)">
    <textarea name="mensaje" placeholder="Mensaje" required></textarea>

    <!-- Campos ocultos para vincular a un coche concreto (opcionales) -->
    <input type="hidden" name="car_id" id="car_id">
    <input type="hidden" name="coche_interes" id="coche_interes">

    <!-- Honeypot anti-spam (oculto a humanos) -->
    <input type="text" name="company" autocomplete="off" tabindex="-1" style="position:absolute; left:-10000px;">

    <button type="submit" id="submit-btn">Enviar</button>
    <p id="form-status" aria-live="polite"></p>
  </form>
  
  </section>

  <footer>
    <p>© 2025 Tu Empresa · Importación y Exportación de Coches</p>
  </footer>
  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://swzizabjkzllxwbrcsnp.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3eml6YWJqa3psbHh3YnJjc25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTU5MTUsImV4cCI6MjA3MTM5MTkxNX0.VDQH9t34ij9BAzV-pd0kXFUru179d1b21VNeV7VlkjA";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ========================
     STOCK: cargar tarjetas
  ========================= */
  async function cargarCoches() {
    const grid = document.querySelector("#stock .grid");
    if (!grid) return;

    const { data, error } = await supabase
      .from("cars")
      .select("id, marca, modelo, version, anio, km, combustible, caja, imagenes, precio_objetivo, created_at")
      .eq("estado_publicacion", "disponible")
      .order("created_at", { ascending: false })
      .limit(12);

    if (error) {
      console.error(error);
      grid.innerHTML = "<p>Error cargando coches.</p>";
      return;
    }

    grid.innerHTML =
      (data || [])
        .map(c => `
        <div class="card">
          <img src="${(c.imagenes?.[0] || 'https://picsum.photos/seed/placeholder/800/450')}" alt="${c.marca} ${c.modelo}">
          <div style="padding:10px">
            <b>${c.marca} ${c.modelo}${c.version ? ' ' + c.version : ''} ${c.anio || ''}</b><br>
            <span>${(c.km ?? 0).toLocaleString('es-ES')} km · ${c.combustible || ''}${c.caja ? ' · ' + c.caja : ''}</span><br>
            ${c.precio_objetivo
              ? `<span class="tag">${Number(c.precio_objetivo).toLocaleString('es-ES')} €</span>`
              : `<span class="tag">Bajo pedido</span>`}
            <div style="margin-top:8px">
              <a class="btn solicitar-oferta" href="#contacto"
                 data-car-id="${c.id}"
                 data-car-name="${c.marca} ${c.modelo}${c.version ? ' ' + c.version : ''} ${c.anio || ''}">
                Solicitar oferta
              </a>
            </div>
          </div>
        </div>
      `)
        .join('') || "<p>Sin coches publicados aún.</p>";
  }

  /* ==================================================
     Al hacer clic en “Solicitar oferta” precargamos el form
  =================================================== */
  document.addEventListener('click', (e) => {
    const link = e.target.closest('.solicitar-oferta');
    if (!link) return;
    const carIdInput   = document.getElementById('car_id');
    const carNameInput = document.getElementById('coche_interes');
    if (carIdInput)   carIdInput.value   = link.dataset.carId || '';
    if (carNameInput) carNameInput.value = link.dataset.carName || '';
  });

  /* =========================================
     FORM: insertar lead + notificar por email
  ========================================== */
  const form = document.getElementById('contact-form');
  const btn = document.getElementById('submit-btn');
  const statusEl = document.getElementById('form-status');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusEl.textContent = '';
    btn.disabled = true;

    const fd = new FormData(form);

    // honeypot: si se rellena, cancelamos (bot)
    if (fd.get('company')) { btn.disabled = false; return; }

    const payload = {
      nombre: (fd.get('nombre') || '').toString().trim(),
      email: (fd.get('email') || '').toString().trim(),
      telefono: (fd.get('telefono') || '').toString().trim() || null,
      mensaje: (fd.get('mensaje') || '').toString().trim(),
      coche_interes: (fd.get('coche_interes') || '').toString().trim() || null,
      car_id: (fd.get('car_id') || '').toString().trim() || null,
      page_url: location.href,
      user_agent: navigator.userAgent
    };

    if (!payload.nombre || !payload.email || !payload.mensaje) {
      statusEl.textContent = 'Por favor, rellena nombre, email y mensaje.';
      btn.disabled = false;
      return;
    }

    // 1) Insertar en Supabase
    const { error } = await supabase.from('leads').insert([payload]);
    if (error) {
      console.error('[Supabase INSERT error]', error);
      statusEl.textContent = 'Error al enviar (BBDD). Intenta de nuevo.';
      btn.disabled = false;
      return;
    }

    // 2) Notificación por email (best effort)
    try {
      await fetch('/api/notify-lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch (err) {
      console.warn('Fallo al notificar por email (opcional):', err);
    }

    // 3) Feedback
    statusEl.textContent = '¡Gracias! Te contactaremos en breve.';
    form.reset();
    document.getElementById('car_id')?.setAttribute('value','');
    document.getElementById('coche_interes')?.setAttribute('value','');
    btn.disabled = false;
  });

  // init
  cargarCoches();
</script>

</body>
</html>
