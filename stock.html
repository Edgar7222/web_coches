<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Stock de coches premium — Tu Empresa</title>
  <meta name="description" content="Explora el stock actualizado de coches premium importados: fotos, kilómetros, combustible, precio y contacto.">
  <meta name="robots" content="index,follow" id="robots-meta">
  <link rel="canonical" href="https://web-coches-eta.vercel.app/stock.html">

  <!-- Social -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Tu Empresa">
  <meta property="og:title" content="Stock de coches premium — Tu Empresa">
  <meta property="og:description" content="Explora el stock actualizado de coches premium importados.">
  <meta property="og:image" content="https://web-coches-eta.vercel.app/og-image.jpg">
  <meta property="og:url" content="https://web-coches-eta.vercel.app/stock.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Stock de coches premium — Tu Empresa">
  <meta name="twitter:description" content="Explora el stock actualizado de coches premium importados.">
  <meta name="twitter:image" content="https://web-coches-eta.vercel.app/og-image.jpg">

  <!-- Favicons / PWA -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#0f172a">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#6366F1; --primary-dark:#4F46E5;
      --bg:#111827; --text:#F9FAFB; --muted:#9CA3AF;
      --card:#1F2937; --border:#374151; --shadow:0 8px 24px rgba(0,0,0,.35);
      --nav-h:64px; --nav-bg:#0f172a; --nav-border:rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.55}
    a{color:inherit;text-decoration:none}

    /* Header + Drawer (solo cierra con la X) */
    .site-header{position:sticky;top:0;z-index:50;background:var(--nav-bg);border-bottom:1px solid var(--nav-border);backdrop-filter:blur(8px) saturate(120%)}
    .nav-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;height:var(--nav-h);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{color:#fff;font-weight:800;letter-spacing:.2px;font-size:clamp(1.05rem,2vw,1.2rem)}
    .nav-desktop{display:none;gap:16px;align-items:center}
    .nav-desktop a{color:rgba(249,250,251,.92);font-weight:600;padding:8px 10px;border-radius:10px;transition:background .2s,color .2s}
    .nav-desktop a:hover{color:#fff;background:rgba(255,255,255,.06)}
    @media (min-width:900px){.nav-toggle{display:none}.nav-desktop{display:flex}}
    .nav-toggle{width:44px;height:44px;border-radius:12px;border:1px solid var(--nav-border);background:transparent;cursor:pointer;display:grid;place-items:center;gap:4px;transition:background .2s,border .2s}
    .nav-toggle:hover{background:rgba(255,255,255,.04)}
    .nav-toggle .bar{width:20px;height:2px;background:#e5e7eb;display:block;border-radius:2px;transition:transform .25s ease,opacity .25s ease}
    .nav-toggle[aria-expanded="true"] .bar:nth-child(1){transform:translateY(6px) rotate(45deg)}
    .nav-toggle[aria-expanded="true"] .bar:nth-child(2){opacity:0}
    .nav-toggle[aria-expanded="true"] .bar:nth-child(3){transform:translateY(-6px) rotate(-45deg)}

    .drawer{position:fixed;inset:0;display:grid;grid-template-columns:1fr;pointer-events:none;z-index:60}
    .drawer-backdrop{display:none}
    .drawer-inner{
      align-self:start;justify-self:end;
      width:clamp(320px,78vw,560px);
      height:100vh;height:100svh;height:100dvh;
      background:#0b1220;border-left:1px solid var(--nav-border);
      box-shadow:-24px 0 48px rgba(0,0,0,.6);
      transform:translateX(100%);transition:transform .28s ease;
      display:flex;flex-direction:column;overflow:auto;-webkit-overflow-scrolling:touch;
      padding:18px;padding-top:calc(16px + env(safe-area-inset-top,0px));
    }
    .drawer.open{pointer-events:auto}
    .drawer.open .drawer-inner{transform:translateX(0)}
    body.nav-open{overflow:hidden;touch-action:none;overscroll-behavior:contain}
    .drawer-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .drawer-title{color:#fff;font-weight:800;letter-spacing:.2px}
    .drawer-close{width:40px;height:40px;border-radius:12px;border:1px solid var(--nav-border);background:#111827;color:#e5e7eb;cursor:pointer;display:flex;align-items:center;justify-content:center}
    @media (min-width:900px){ .drawer{display:none} } /* oculto total en desktop */

    /* Layout */
    .container{max-width:1200px;margin:0 auto;padding:28px 18px}
    h1{font-size:clamp(1.6rem,2.4vw,2.25rem);margin:8px 0 18px;font-weight:800;letter-spacing:.2px;color:#fff}

    /* Filtros */
    .filters{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin:10px 0 22px}
    .filters form{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;background:transparent;box-shadow:none;border:none;padding:0;margin:0;max-width:none}
    .filters label{font-weight:600;color:#E5E7EB}
    .filters input,.filters select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0B1220;color:var(--text)}
    .filters .span-3{grid-column:span 3} .filters .span-2{grid-column:span 2} .filters .span-4{grid-column:span 4}
    .filters .actions{display:flex;gap:10px;align-items:end}
    @media (max-width:900px){ .filters form{grid-template-columns:1fr 1fr;}.filters .span-3,.filters .span-2,.filters .span-4{grid-column:span 1} .filters .actions{grid-column:1/-1} }

    .btn{display:inline-block;padding:12px 18px;border-radius:999px;font-weight:700;cursor:pointer;border:none}
    .btn.primary{background:var(--primary);color:#fff;box-shadow:0 6px 18px rgba(99,102,241,.25)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:#E5E7EB}

    /* Grid de coches */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin:16px 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);transition:.2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(0,0,0,.45)}
    .card img{width:100%;border-radius:12px;margin-bottom:10px;display:block;aspect-ratio:16/9;object-fit:cover}
    .card b{color:#fff} .card span{color:var(--muted)}

    .empty{color:var(--muted);text-align:center;padding:20px}
    .load-more{display:flex;justify-content:center;margin:12px 0 24px}
  </style>

  <!-- Utils (defer) -->
  <script src="js/utils.js" defer></script>

  <!-- Noindex si hay parámetros (evitar duplicados por filtros) -->
  <script>
    (function(){
      if (location.search && document.getElementById('robots-meta')) {
        document.getElementById('robots-meta').setAttribute('content','noindex,follow');
      }
    })();
  </script>
</head>
<body>

  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="nav-wrap">
      <a class="brand" href="/" aria-label="Inicio">Tu Empresa</a>
      <button id="nav-toggle" class="nav-toggle" aria-label="Abrir menú" aria-controls="mobile-drawer" aria-expanded="false">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
      <nav class="nav-desktop" aria-label="Menú principal">
        <a href="/">Inicio</a>
        <a href="/stock.html" class="btn primary">Stock</a>
        <a href="/#contacto">Contacto</a>
      </nav>
    </div>

    <!-- Drawer -->
    <div id="mobile-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Menú">
      <div class="drawer-inner">
        <div class="drawer-top">
          <span class="drawer-title">Menú</span>
          <button class="drawer-close" aria-label="Cerrar menú">✕</button>
        </div>
        <nav class="drawer-nav" style="display:flex;flex-direction:column;gap:12px">
          <a href="/" class="drawer-link">Inicio</a>
          <a href="/stock.html" class="drawer-link">Stock</a>
          <a href="/#contacto" class="drawer-link btn primary" style="text-align:center;">Contacto</a>
        </nav>
        <div style="height:calc(12px + env(safe-area-inset-bottom,0px))"></div>
      </div>
      <button class="drawer-backdrop" tabindex="-1" aria-hidden="true"></button>
    </div>
  </header>

  <main class="container">
    <h1>Stock de coches disponibles</h1>

    <!-- Filtros -->
    <section class="filters" aria-label="Filtros de búsqueda">
      <form id="filters-form">
        <div class="span-4">
          <label for="q">Buscar</label>
          <input id="q" name="q" type="search" placeholder="Marca / modelo / versión">
        </div>
        <div class="span-2">
          <label for="marca">Marca</label>
          <input id="marca" name="marca" type="text" placeholder="Audi, BMW...">
        </div>
        <div class="span-2">
          <label for="combustible">Combustible</label>
          <select id="combustible" name="combustible">
            <option value="">Cualquiera</option>
            <option>Gasolina</option><option>Diésel</option>
            <option>Híbrido</option><option>Eléctrico</option><option>Otro</option>
          </select>
        </div>
        <div class="span-2">
          <label for="caja">Caja</label>
          <select id="caja" name="caja">
            <option value="">Cualquiera</option>
            <option>Manual</option><option>Automático</option>
          </select>
        </div>
        <div class="span-1">
          <label for="anio_min">Año mín.</label>
          <input id="anio_min" name="anio_min" type="number" min="1990" max="2100" inputmode="numeric">
        </div>
        <div class="span-1">
          <label for="anio_max">Año máx.</label>
          <input id="anio_max" name="anio_max" type="number" min="1990" max="2100" inputmode="numeric">
        </div>
        <div class="span-2">
          <label for="precio_min">€ mín.</label>
          <input id="precio_min" name="precio_min" type="number" min="0" step="1000" inputmode="numeric">
        </div>
        <div class="span-2">
          <label for="precio_max">€ máx.</label>
          <input id="precio_max" name="precio_max" type="number" min="0" step="1000" inputmode="numeric">
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Aplicar</button>
          <button class="btn ghost" type="button" id="clear-filters">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- Resultados -->
    <section aria-labelledby="stock-title">
      <div class="grid" id="stock-grid" role="list"></div>
      <div class="empty" id="empty" style="display:none">No se han encontrado coches con esos filtros.</div>
      <div class="load-more">
        <button id="load-more" class="btn ghost" style="display:none">Cargar más</button>
      </div>
    </section>
  </main>

  <script type="application/ld+json" id="itemlist-jsonld"></script>

  <!-- App: filtros + stock -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase público
    const SUPABASE_URL  = "https://swzizabjkzllxwbrcsnp.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3eml6YWJqa3psbHh3YnJjc25wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MTU5MTUsImV4cCI6MjA3MTM5MTkxNX0.VDQH9t34ij9BAzV-pd0kXFUru179d1b21VNeV7VlkjA";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const grid = document.getElementById("stock-grid");
    const emptyEl = document.getElementById("empty");
    const loadMoreBtn = document.getElementById("load-more");
    const form = document.getElementById("filters-form");
    const params = new URLSearchParams(location.search);

    const PAGE_SIZE = 12;
    let offset = 0;
    let lastCount = 0;

    const cardHTML = (c) => {
      const titulo = `${c.marca ?? ""} ${c.modelo ?? ""} ${c.version ? c.version+" " : ""}${c.anio ?? ""}`.trim();
      const imgSrc = (Array.isArray(c.imagenes) && c.imagenes[0]) ? c.imagenes[0] : "https://picsum.photos/seed/placeholder/800/450";
      const km = (c.km ?? 0).toLocaleString("es-ES");
      const resumen = [km && `${km} km`, c.combustible, c.caja].filter(Boolean).join(" · ");
      const precio = c.precio_objetivo ? `${Number(c.precio_objetivo).toLocaleString("es-ES")} €` : "Bajo pedido";
      return `
        <article class="card" role="listitem">
          <a href="car.html?id=${encodeURIComponent(c.id)}" aria-label="Ver ${sanitizeHTML(titulo)}">
            <img src="${imgSrc}" alt="${sanitizeHTML(titulo)}" loading="lazy" decoding="async" width="400" height="260">
          </a>
          <div>
            <b>${sanitizeHTML(titulo)}</b><br>
            <span>${sanitizeHTML(resumen)}</span><br>
            <span class="tag" style="color:#E5E7EB">${sanitizeHTML(precio)}</span>
          </div>
        </article>`;
    };

    function setFormFromParams() {
      ["q","marca","combustible","caja","anio_min","anio_max","precio_min","precio_max"].forEach(k=>{
        const el = document.getElementById(k);
        if (!el) return;
        const v = params.get(k) || "";
        el.value = v;
      });
    }

    function updateUrlFromForm() {
      const data = new FormData(form);
      const keys = ["q","marca","combustible","caja","anio_min","anio_max","precio_min","precio_max"];
      const p = new URLSearchParams();
      keys.forEach(k => {
        const v = (data.get(k) || "").toString().trim();
        if (v) p.set(k, v);
      });
      const qs = p.toString();
      history.replaceState(null, "", qs ? `?${qs}` : location.pathname);
      // Si hay filtros => noindex (por duplicados)
      const robots = document.getElementById('robots-meta');
      if (robots) robots.setAttribute('content', qs ? 'noindex,follow' : 'index,follow');
    }

    function buildQuery() {
      let q = supabase.from("cars")
        .select("id, marca, modelo, version, anio, km, combustible, caja, imagenes, precio_objetivo, created_at, estado_publicacion", { count: "exact" })
        .in("estado_publicacion", ["publicado", "disponible"]);

      const qtext = (params.get("q")||"").trim();
      const marca = (params.get("marca")||"").trim();
      const comb = (params.get("combustible")||"").trim();
      const caja = (params.get("caja")||"").trim();
      const anio_min = +(params.get("anio_min")||"");
      const anio_max = +(params.get("anio_max")||"");
      const precio_min = +(params.get("precio_min")||"");
      const precio_max = +(params.get("precio_max")||"");

      if (qtext) q = q.or(`marca.ilike.%${qtext}%,modelo.ilike.%${qtext}%,version.ilike.%${qtext}%`);
      if (marca) q = q.ilike("marca", `%${marca}%`);
      if (comb) q = q.eq("combustible", comb);
      if (caja) q = q.eq("caja", caja);
      if (anio_min) q = q.gte("anio", anio_min);
      if (anio_max) q = q.lte("anio", anio_max);
      if (precio_min) q = q.gte("precio_objetivo", precio_min);
      if (precio_max) q = q.lte("precio_objetivo", precio_max);

      q = q.order("created_at", { ascending: false })
           .range(offset, offset + PAGE_SIZE - 1);

      return q;
    }

    async function loadPage(append=false) {
      const { data, error, count } = await buildQuery();
      if (error) { console.error(error); if (!append) grid.innerHTML = ""; emptyEl.style.display="block"; loadMoreBtn.style.display="none"; return; }

      lastCount = count ?? 0;
      if (!append) grid.innerHTML = "";
      if (!data?.length && !append) {
        emptyEl.style.display = "block";
        loadMoreBtn.style.display = "none";
        injectItemListJSONLD([]);
        return;
      }

      emptyEl.style.display = "none";
      grid.insertAdjacentHTML("beforeend", data.map(cardHTML).join(""));

      // Mostrar/ocultar "Cargar más"
      const totalLoaded = grid.querySelectorAll(".card").length;
      if (totalLoaded < lastCount) { loadMoreBtn.style.display = "inline-block"; }
      else { loadMoreBtn.style.display = "none"; }

      // JSON-LD ItemList con lo cargado (máx 24 para no inflar)
      const items = [...grid.querySelectorAll(".card a")].slice(0,24).map((a,i)=>({
        "@type":"ListItem", "position": i+1, "url": new URL(a.getAttribute("href"), location.origin).toString()
      }));
      injectItemListJSONLD(items);
    }

    function injectItemListJSONLD(items){
      const el = document.getElementById("itemlist-jsonld");
      const json = {
        "@context":"https://schema.org",
        "@type":"ItemList",
        "itemListElement": items
      };
      el.textContent = JSON.stringify(json);
    }

    // Eventos filtros
    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      offset = 0;
      updateUrlFromForm();
      loadPage(false);
    });
    document.getElementById("clear-filters").addEventListener("click", ()=>{
      form.reset();
      offset = 0;
      history.replaceState(null, "", location.pathname);
      const robots = document.getElementById('robots-meta'); if (robots) robots.setAttribute('content','index,follow');
      loadPage(false);
    });

    // Cargar más
    loadMoreBtn.addEventListener("click", ()=>{
      offset += PAGE_SIZE;
      loadPage(true);
    });

    // Init desde URL
    setFormFromParams();
    loadPage(false);
  </script>

  <!-- Menú (solo X cierra, igual que index) -->
  <script>
    (() => {
      const toggleBtn = document.getElementById('nav-toggle');
      const drawer    = document.getElementById('mobile-drawer');
      const closeBtn  = drawer?.querySelector('.drawer-close');
      if (!toggleBtn || !drawer) return;

      const focusableSel = ['a[href]','button:not([disabled])','input','select','textarea','[tabindex]:not([tabindex="-1"])'].join(',');
      let lastFocused = null;

      const open = () => {
        lastFocused = document.activeElement;
        drawer.classList.add('open');
        document.body.classList.add('nav-open');
        toggleBtn.setAttribute('aria-expanded','true');
        drawer.querySelector(focusableSel)?.focus({preventScroll:true});
      };
      const close = () => {
        drawer.classList.remove('open');
        document.body.classList.remove('nav-open');
        toggleBtn.setAttribute('aria-expanded','false');
        lastFocused?.focus?.({preventScroll:true});
      };
      const isOpen = () => drawer.classList.contains('open');

      toggleBtn.addEventListener('click', () => isOpen() ? close() : open(), { passive:true });
      closeBtn?.addEventListener('click', close, { passive:true });

      window.addEventListener('keydown', (e) => {
        if (!isOpen()) return;
        if (e.key === 'Escape') { e.preventDefault(); close(); }
        if (e.key === 'Tab') {
          const f = [...drawer.querySelectorAll(focusableSel)];
          if (!f.length) return;
          const first = f[0], last = f[f.length-1];
          if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      });

      // Resets bfcache/iOS
      const resetDrawerState = () => { drawer.classList.remove('open'); document.body.classList.remove('nav-open'); toggleBtn.setAttribute('aria-expanded','false'); };
      window.addEventListener('pageshow', resetDrawerState);
      window.addEventListener('pagehide', resetDrawerState);
      window.addEventListener('beforeunload', resetDrawerState);
      document.addEventListener('visibilitychange', () => { if (document.hidden) resetDrawerState(); });
    })();
  </script>
</body>
</html>
