export default async function handler(req, res) {
  const SITE = 'https://web-coches-eta.vercel.app';

  const SUPABASE_URL = process.env.SUPABASE_URL;            // p.ej. https://swzizabjkzllxwbrcsnp.supabase.co
  const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;  // tu anon (mejor en env, no hardcode)

  // Pedimos coches publicados/disponibles (usando REST de Supabase)
  const url = new URL(`${SUPABASE_URL}/rest/v1/cars`);
  url.searchParams.set('select', 'id,updated_at,created_at,estado_publicacion');
  url.searchParams.set('estado_publicacion', 'in.(publicado,disponible)');

  const r = await fetch(url.toString(), {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    },
    // Opcional: cache del edge
    next: { revalidate: 3600 },
  });

  const cars = r.ok ? await r.json() : [];

  const carUrls = cars.map((c) => {
    const last = c.updated_at || c.created_at || new Date().toISOString();
    const loc = `${SITE}/car.html?id=${encodeURIComponent(c.id)}`;
    return `<url><loc>${loc}</loc><lastmod>${new Date(last).toISOString()}</lastmod><changefreq>weekly</changefreq><priority>0.8</priority></url>`;
  }).join('');

  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>${SITE}/</loc>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  ${carUrls}
</urlset>`;

  res.setHeader('Content-Type', 'application/xml; charset=utf-8');
  res.setHeader('Cache-Control', 's-maxage=3600, stale-while-revalidate=86400');
  res.status(200).send(xml);
}
